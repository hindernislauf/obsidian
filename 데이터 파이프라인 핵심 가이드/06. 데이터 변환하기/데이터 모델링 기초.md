ELT 패턴의 데이터 모델링의 원칙

- 주요 데이터 모델링 용어
	- 측정
	  측정하고 싶은 것, 예에는 고객 수와 수익의 달러 가치가 포함
	- 속성
	  보고서 또는 대시보드에서 필터링하거나 그룹화하려는 항목, 예에는 날짜, 고객 이름 및 국가 가 포함
데이터 모델의 세분성(granularity)
> **세분성**은 데이터 모델에서 저장된 세부 정보 수준을 말한다.

팩트(Fact)와 차원(Dimension)
> 차원 모델링의 기본 사항에 대해 더 많이 배울 것을 적극 권장.

세분성 최적화
> 데이터 모델의 레코드 수는 모델에 사용된 소스 테이블의 데이터 양, 속성 수 및 세분성의 요인이다.
> 항상 필요한 가장 작은 단위의 세분성으로 모델링해야 하며, 그 이하로 모델링해서도 안 된다.
> 모델이 월별 측정값만 제공해야하는 경우 일일 단위를 설정할 필요가 없으며, 일일 단위로 설정할 경우 모델이 저장하고 쿼리해야하는 레코드 수 만 증가.

완전히 새로 고침 된 데이터를 사용하면 각 수집 사이에 Customers 테이블의 전체 기록을 유지하고 이러한 변경 사항을 스스로 추적해야 한다.
-> Kimball(차원) 모델링에 정의되어 있으며 천천히 변화하는 차원 또는 SCD(slowly changing dimension)


```sql
-- # 테이블 생성

CREATE TABLE Orders (

OrderId int,

OrderStatus varchar(30),

OrderDate timestamp,

CustomerId int,

OrderTotal numeric

);

  

INSERT INTO Orders

VALUES(1,'Shipped','2020-06-09',100,50.05);

INSERT INTO Orders

VALUES(2,'Shipped','2020-07-11',101,57.45);

INSERT INTO Orders

VALUES(3,'Shipped','2020-07-12',102,135.99);

INSERT INTO Orders

VALUES(4,'Shipped','2020-07-12',100,43.00);

  
  

CREATE TABLE Customers

(

CustomerId int,

CustomerName varchar(20),

CustomerCountry varchar(10)

);

  

INSERT INTO Customers VALUES(100,'Jane','USA');

INSERT INTO Customers VALUES(101,'Bob','UK');

INSERT INTO Customers VALUES(102,'Miles','UK');

  

-- # 모델의 구조를 정의한 다음 두 테이블을 조인해서 가져온 데이터를 삽입,

CREATE TABLE IF NOT EXISTS order_summary_daily (

order_date date,

order_country varchar(10),

total_revenue numeric,

order_count int

);

  

INSERT INTO order_summary_daily

(order_date, order_country,

total_revenue, order_count)

SELECT

o.OrderDate AS order_date,

c.CustomerCountry AS order_country,

SUM(o.OrderTotal) as total_revenue,

COUNT(o.OrderId) AS order_count

FROM Orders o

INNER JOIN Customers c on

c.CustomerId = o.CustomerId

GROUP BY o.OrderDate, c.CustomerCountry;

  

-- # 특정 월에 특정 국가에서 발생한 주문으로 발생한 수익은 얼마인가?

-- # Mysql용 DATE_PART('month', order_date) -> month(order_date)

SELECT

-- DATE_PART('month', order_date) as order_month,

month( order_date) as order_month,

order_country,

SUM(total_revenue) as order_revenue

FROM

order_summary_daily

GROUP BY

-- DATE_PART('month', order_date),

month( order_date),

order_country

ORDER BY

-- DATE_PART('month', order_date),

month( order_date),

order_country;

  

-- # 특정 날짜에 주문이 몇 개나 들어왔는가?

SELECT

order_date,

SUM(order_count) as total_orders

FROM

order_summary_daily

GROUP BY

order_date

ORDER BY

order_date;

  

-- # Jane 고객 레코드 유형 II SCD

CREATE TABLE Customers_scd

(

CustomerId int,

CustomerName varchar(20),

CustomerCountry Varchar(10),

ValidFrom timestamp,

Expired timestamp

);

  

INSERT INTO

Customers_scd

VALUES

(100, 'Jane', 'USA', '2019-05-01 07:01:10', '2020-06-20 8:15:34');

INSERT INTO

Customers_scd

VALUES

(100, 'Jane', 'UK', '2020-06-20 8:15:34', '2024-12-31 00:00:00');

-- (100, 'Jane', 'UK', '2020-06-20 8:15:34', '2199-12-31 00:00:00');

  
  

-- # Jane 이 국가 변경되는 시점을 출력

SELECT

o.OrderId,

o.OrderDate,

c.CustomerName,

c.CustomerCountry

FROM

Orders o

INNER JOIN

Customers_scd c

ON o.CustomerId = c.CustomerId

AND o.OrderDate BETWEEN c.ValidFrom AND c.Expired

ORDER BY

o.OrderDate;

  

-- # Customers_staging 테이블에 작성, 100번 사람 갱신

CREATE TABLE Customers_staging(

CustomerId int,

CustomerName varchar(20),

CustomerCountry varchar(10),

LastUpdated timestamp

);

  

INSERT INTO Customers_staging

VALUES (100, 'Jane', 'USA', '2019-05-01 7:01:10');

INSERT INTO Customers_staging

VALUES (101, 'Bob', 'UK', '2020-01-15 13:05:31');

INSERT INTO Customers_staging

VALUES (102, 'Miles', 'UK', '2020-01-29 9:12:00');

INSERT INTO Customers_staging

VALUES (100, 'Jane', 'UK', '2020-06-20 8:15:34');

  

-- # 현재 국가로 데이터를 관리 할 때

CREATE TABLE order_summary_daily_current

(

order_date date,

order_country varchar(10),

total_revenue numeric,

order_count int

);

  

INSERT INTO order_summary_daily_current

(order_date, order_country, total_revenue, order_count)

WITH customers_current AS

(

SELECT CustomerId,

MAX(LastUpdated) AS latest_update

FROM Customers_staging

GROUP BY CustomerId

)

SELECT

o.OrderDate AS order_date,

cs.CustomerCountry AS order_country,

SUM(o.OrderTotal) As total_revenue,

COUNT(o.OrderId) AS order_count

FROM Orders o

INNER JOIN customers_current cc

ON cc.CustomerId = o.CustomerId

INNER JOIN Customers_staging cs

ON cs.CustomerId = cc.CustomerId

AND cs.LastUpdated = cc.latest_update

GROUP BY o.OrderDate, cs.CustomerCountry;

  

-- # 출력하기

  

SELECT

month(order_date) AS order_month, order_country
```